## I2C通信协议

---

$I^2C$总线（Inter IC BUS）是一种非常通用的总线通信协议

它的特点包括：

- 只使用**两根通信线 SCL**(Serial Clock) 和 **SDA**(Serial Data)
- **半双工**（同一时刻只能进行发送或者接收中的一种状态）
- 能够实现**一主多从**，**多主多从**（需要设计时钟同步和主机仲裁
- 对硬件要求低，只需要两个GPIO执行简单的电平控制，便于用软件来模拟

首先，使用I2C通信有对应的的硬件连接要求，即

- *所有的主机和从机的SCL线共同连接在一起，在一主多从的模式下，主机在通信的整个时刻保持对SCL线的控制（只有主机的SCL口可以设置为输出，其他从机只能设置为输入（浮空输入或者上拉输入）*
- *所有主机和从机的SDA线共同连接在一起，共用一根线传输数据。在整个通信的时间段上只有一个设备能够控制SDA线（这意味着SDA的控制权是在各主从设备间不断更换的），所有的设备都要配置成开漏输出模式*

> 设置成开漏输出模式能够使设备保持高电平时可以与其他设备输出的低电平线与，最后表征为低电平（重点是能够轻松线与了）

* *设置成开漏输出的两条数据线由于都是开漏输出模式，所以都需要添加上拉电阻*，这个电阻的阻值一般为4.7k欧姆

#### I2C总线的时序

##### 起始单元

通信的第一个环节为起始单元，在这个环节，要求在**SCl高电平期间将SDA从高电平切换成低电平**

![](D:\desktop\stm32\STM32Markdown笔记\STM32_Learning\I2C协议\I2C协议_起始单元.jpg)

##### 发送单元

主机在通信的发送单元发送信息，这个环节要求**主机在SCL低电平期间将数据位放在SDA线上，数据位放置完成之后主机释放SCL使其被上拉为高电平，从机在SCL高电平期间读取SDA的电平，循环8次完成一个字节的数据发送**

![I2C协议_发送单元](D:\desktop\stm32\STM32Markdown笔记\STM32_Learning\I2C协议\I2C协议_发送单元.jpg)

> 注意，使用I2C发送信息时使用的是**高位在前**的方式，即对于一个字节$b_7b_6b_5b_4b_3b_2b_1b_0$的数据先发送最高位$b_7$,最后发送最低位$b_0$

同时，当SCL为高电平时，从机通过SDA读取数据，这要求**SCL高电平期间SDA不允许有数据变化**。且当主机进入中断时，SCL与SDA两根数据线都保持电平不变，这时对数据传输不具有影响

##### 接收单元

主机在通信的接收单元接收信息，这个环节从机先在SCL线下拉至低电平，同时将数据位依次放到SDA线上，当数据位放置完全时，从机释放SCL，此时SCL线上将自动被上拉到高电平。主机在高电平时读取数据位,同样在SCL高电平期间SDA上不允许有电平变化。循环8次即可接收一个字节。时序图和发送类似，区别在与SDA的控制和SCL的下拉由从机完全控制。

> 注意，主机在接收信号之前需要释放SDA

##### 终止单元

通信的最后为终止单元，在这个环节中要求**SCL高电平期间将SDA从低电平切换成高电平**

![I2C协议_终止单元](D:\desktop\stm32\STM32Markdown笔记\STM32_Learning\I2C协议\I2C协议_终止单元.jpg)

##### 发送应答和接收应答

主机**在接收一个字节之后，在下一个时钟发送一位表示应答的数据**。这一位数据位为0时表示应答，这一位数据为1时表示非应答

主机**在发送一个字节之后，在下一个时钟接收一位判断应答**，这一位为0表示应答，为1表示非应答

发送完一个字节之后，主机将在最后一位发送完之后的SCL低电平期间释放SDA，从而在主机释放之后SDA上的信号自动被上拉为高电平，这时由接收完数据的从机进行发送应答来把SDA再拉低。若在这个时刻主机的接收应答和从机的发送应答能够同时配合好，则不会有下一个SCL变成高电平时出现SDA变成高电平的现象（主机放手从机拉低）



##### 指定地址写

这个操作用于对指定的设备的指定地址单元（通常是某个寄存器）写入数据

此时的逻辑为 起始单元 + 指定设备地址（7位）+读写位（1位，0写1读）+ 应答位 + 指定地址或指令控制（8位） + 应答位 + 数据字节（8位）+ 应答位 + 终止单元 

##### 当前地址读

这个操作用于读取指定设备的地址指针指向的地址位上的数据。

> 在待读取的从机上配置有地址指针，每经过一次读写操作指针会自动加1

此时逻辑为 起始单元 + 指定设备地址 + 读写位 + 应答位 + 数据字节 + 应答位 + 终止单元 

##### 指定地址读

指定地址读是一种复合模式，它将指定地址写和当前地址读结合起来，先执行指定地址写，再执行指定地址读

逻辑为 起始单元 + 指定设备地址 + 读写位（0） + 应答位 + （可省略的终止单元） + 指定地址 + 应答位 + 起始条件 + 指定设备地址 + 读写位（1） + 应答位 + 数据位 + 应答位 + 终止单元

> I2C的基础规定每次读写一个字节，但同时也允许每次读多个字节。需要改变的操作只要把在最后的 「数据字节 + 应答位」共9位重复多遍，完成多个字节的传输之后再加上终止单元既可。这时的读写是默认连续地址的，且读数据时主机的应答位决定了是否要继续，主机发送应答位为0说明已应答且还要继续，当主机发送应答位为1时从机将释放SDA控制权，从机不再发送数据

